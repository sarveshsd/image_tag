name: Build and Push Docker Image to GCR

on:
  push:
    branches:
      - main  # Trigger on push to main branch
      - test

jobs:
  build:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Google Cloud
      id: auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_KEY_FILE }}

    - name: Configure docker to use the gcloud command-line tool as a credential helper
      run: |
        gcloud --quiet auth configure-docker

    - name: Extract GCP project ID
      id: project
      run: echo "::set-output name=id::${{ secrets.GCP_PROJECT_ID }}"

    - name: Build and push Docker images to GCR
      run: |
        docker-compose down
        docker-compose up -d

        # Tag images for GCR
        docker tag devops-fullstack-app-frontend:v1 gcr.io/${{ secrets.GCP_PROJECT_ID }}/sarveshsd/devops-fullstack-app-frontend:v1
        docker tag devops-fullstack-app-backend:v1 gcr.io/${{ secrets.GCP_PROJECT_ID }}/sarveshsd/devops-fullstack-app-backend:v1
        docker tag postgres:13 gcr.io/${{ secrets.GCP_PROJECT_ID }}/sarveshsd/postgres:13

        # Push images to GCR
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/sarveshsd/devops-fullstack-app-frontend:v1
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/sarveshsd/devops-fullstack-app-backend:v1
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/sarveshsd/postgres:13

        docker-compose down
